language: generic

compiler:
    - g++

sudo: required

dist: trusty

addons:
  apt:
    sources:
    #- sourceline: 'ppa:dhor/myway'
    - sourceline: 'ppa:otto-kesselgulasch/gimp-edge'
    packages:
      - g++
      - gettext
      - intltool
      - gir1.2-gtk-3.0
      - libgtk2.0-dev
      - liblcms2-dev
      - libpng12-dev
      - python-dev
      - python-gi-dev
      - python-gi-cairo
      - python-nose
      - python-numpy
      - automake
      - gtk-doc-tools
      - gobject-introspection
      - libfftw3-dev-
      - libjpeg-turbo8-dev
      - libpng12-dev
      - libwebp-dev
      - libtiff4-dev
      - libxml2-dev
      - swig
      - libmagick++-dev
      - bc
      - libcfitsio3-dev
      - libgsl0-dev
      - libmatio-dev
      - liborc-0.4-dev
      - liblcms2-dev
      - libpoppler-glib-dev
      - librsvg2-dev
      - libgif-dev
      - libpango1.0-dev
      - python-dev
      - libgtk2.0-dev
      - libfftw3-dev
      - libexiv2-dev
      - libgexiv2-dev
      - libsigc++-2.0-dev
      - libpixman-1-dev
      - libpango1.0-dev
      - libpangoft2-1.0-0
      - libglib2.0-dev
      - libglibmm-2.4-dev
      - libgtkmm-2.4-dev
      - libpugixml-dev


branches:
  except:
    - # Do not build tags that we create when we upload to GitHub Releases
    - /^(?i:continuous)$/
    
before_script:
    - cd build
    - export PKG_CONFIG_PATH=/app/lib/pkgconfig:${PKG_CONFIG_PATH}
    - export LD_LIBRARY_PATH=/app/lib:${LD_LIBRARY_PATH}
    #- git clone -b v8.4.1 --depth 1 https://github.com/jcupitt/libvips.git libvips
    - git clone https://github.com/jcupitt/libvips.git libvips
    - cd libvips
    # revert to git version of 9/2/2017
    - git reset --hard 6691e07d72c284468c77f4a95139ac43bf0cdc6f
    #- wget http://www.vips.ecs.soton.ac.uk/supported/8.4/vips-8.4.5.tar.gz
    #- tar xzvf vips-8.4.5.tar.gz
    #- cd vips-8.4.5
    - ./autogen.sh
    - FLAGS="-g -O2 -msse4.2 -ffast-math -ftree-vectorize" CFLAGS="${FLAGS}" CXXFLAGS="${FLAGS} -fpermissive" ./configure --prefix=/app --disable-gtk-doc --disable-gtk-doc-html --disable-introspection --enable-debug=no --without-python --without-magick --without-libwebp --enable-pyvips8=no --enable-shared=yes --enable-static=no
    - make -j2
    - sudo make install
    - cd ..
    - rm -rf libvips
    - cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/app -DINSTALL_PREFIX=/app -DBUNDLED_LENSFUN=ON ..
    - echo "#include <version.hh>" > ../src/version.cc
    - echo "const char* PF::version_string = \"PhotoFlow git-${TRAVIS_BRANCH}-${TRAVIS_COMMIT}\";" >> ../src/version.cc
    - make -j2
    - sudo make install
    - cd ..
    - sudo rm -fr PhotoFlow

script:
    - bash appimage/appimage.sh
    
after_success:
    - cd $HOME
    - pwd
    - ls -lh
    - ls -lh out/* # Assuming you have some files in out/ that you would like to upload
    #- wget -c https://github.com/probonopd/uploadtool/raw/master/upload.sh
    #- wget -c https://github.com/aferrero2707/uploadtool/raw/master/upload.sh
    - wget -c https://github.com/aferrero2707/uploadtool/raw/master/upload_rotate.sh
    - bash  ./upload_rotate.sh out/*
